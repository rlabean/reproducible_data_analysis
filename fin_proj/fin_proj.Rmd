---
title: "Geoscience Salary Survey"
output: html_notebook
author: Robert LaBean
---

```{r echo=FALSE}

library(tidyverse)
library(readxl)
library(rvest)

```

Accessing the Bureau of Labor Statistics most current state salary data.

```{r}

url <- "https://www.bls.gov/oes/special.requests/oesm19st.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
raw_salary_data <- read_excel(file.path(temp2, "oesm19st/state_M2019_dl.xlsx"))

unlink(c(temp, temp2))

```

Next, we're going to scrape the Missouri Economic Research and Information Center (MERIC) web page an use their calculation for a cost of living index. I like this calculation because they take the cost of living index for each city in a state and average it to make a state cost of living index.

```{r}

scrape_url <- "https://meric.mo.gov/data/cost-living-data-series"
webpage <- read_html(scrape_url)
web_tables <- html_nodes(webpage, "table")
state_list <- html_table(web_tables)[[1]]

glimpse(state_list)

```

Now, I'm combining both data-sets into one. I'm also cleaning the data a bit as we aren't going to be needing a lot of the information from the MERIC data-set

```{r}

col_index <- filter(state_list, !grepl("District of Columbia|Puerto Rico|US", State)) %>%
  arrange(State)

salary_data <- inner_join(raw_salary_data, col_index, by = c("area_title" = "State")) %>%
  filter(occ_code == "19-2042")

salary_data$normalized = as.numeric(salary_data$a_mean) / (salary_data$Index/100)


glimpse(col_index)

```

Finally we're going to normalize all the salaries with our cost of living index and plot it on a chart to see which states typically have the highest salaries compared to their respective cost of living. 

```{r}


# plot_sal_data <- function(occ_code, x, y){
#   filter(salary_data, occ_code == occ_code)
#   
# salary_plot <- ggplot(salary_data) +
#   theme(axis.text.x = element_text(angle = 90)+
#     geom_col(mapping = aes(x, y)))
#   
# print(salary_plot)
#     }
# 
# plot_sal_data("19-2042", salary_data$area_title, salary_data$a_mean)
# plot_sal_data("19-2042", salary_data$area_title, salary_data$normalized)


salary_plot2 <- ggplot(salary_data) +
  theme_light()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust = 1), 
        axis.title.x = element_blank(), legend.position = "left")+
  labs(title = "Average Geoscientist Salary", y ="Annual Salary (USD)")+
  geom_col(mapping = aes(area_title, normalized), width = 0.8,
           fill = "black", color = "black")+
  geom_col(mapping = aes(area_title, as.numeric(a_mean)),width = 0.3, fill = "red")+
  scale_y_continuous(limits = c(0, 175000), breaks = seq(0, 175000, 25000), 
                     labels = c("0" = "$0", "25000" = "$25k", "50000" = "$50k", 
                                "75000" = "$75k", "100000" = "$100k", 
                                "125000" = "$125k", "150000" = "$150k", 
                                "175000" = "$175k"))
  


  
print(salary_plot2)


```